generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    Int            @id @default(autoincrement())
  avatar                String?
  name                  String?
  email                 String?        @unique
  description           String?
  links                 Json?
  metadata              Json?          @default("{}")
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  walletAddress         String
  ownedGrantsPools      GrantsPool[]   @relation("UserGrantsPools")
  pods                  Pod[]          @relation("UserPods")
  sentNotifications     Notification[] @relation("SentNotifications")
  receivedNotifications Notification[] @relation("ReceivedNotifications")

  @@index([email])
  @@index([walletAddress])
}

model GrantsPool {
  id               Int              @id @default(autoincrement())
  avatar           String?
  name             String
  description      String
  links            Json?
  tags             String?
  tokens           GrantsPoolTokens[] @default([USDT])
  modInfo          Json
  treasuryWallet   String
  chainType        ChainType        @default(OPTIMISM)
  status           GrantsPoolStatus @default(ACTIVE)
  metadata         Json?            @default("{}")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  ownerId          Int
  owner            User             @relation("UserGrantsPools", fields: [ownerId], references: [id])
  pods             Pod[]            @relation("GrantsPoolPods")
  rfps             Rfps[]

  @@index([name])
  @@index([chainType])
  @@index([status])
  @@index([ownerId])
  @@index([treasuryWallet])
}

enum GrantsPoolStatus {
  ACTIVE
  INACTIVE
}

enum GrantsPoolTokens {
  USDC
  USDT
}

model Rfps {
  id           Int        @id @default(autoincrement())
  grantsPoolId Int
  title        String
  description  String
  metadata     Json?      @default("{}")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  inactiveTime DateTime?
  grantsPool   GrantsPool @relation(fields: [grantsPoolId], references: [id], onDelete: Cascade)
  pods         Pod[]      @relation("RfpPods")

  @@index([grantsPoolId])
}

model Pod {
  id               Int         @id @default(autoincrement())
  applicantId      Int
  grantsPoolId     Int
  rfpId            Int
  walletAddress    String
  avatar           String?
  title            String
  description      String
  links            Json?
  tags             String?
  currency         String
  status           PodStatus   @default(REVIEWING)
  metadata         Json?       @default("{}") // {rejectReason: string}
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  approvedAt       DateTime?
  milestones       Milestone[] @relation("PodMilestones")
  applicant        User        @relation("UserPods", fields: [applicantId], references: [id])
  grantsPool       GrantsPool  @relation("GrantsPoolPods", fields: [grantsPoolId], references: [id])
  rfp              Rfps        @relation("RfpPods", fields: [rfpId], references: [id])
  safeTransactionHash Json     @default("{}") // 用金额与类型记录转账 hash 存入 {type_amount: string} eg {in_100:0xxxxxxx, out_100:0xxxxxxx}
  versions         Json[] // 版本号，用于记录每次编辑的信息

  @@index([applicantId])
  @@index([grantsPoolId])
  @@index([rfpId])
  @@index([status])
}

model Milestone {
  id           Int             @id @default(autoincrement())
  podId        Int
  title        String
  description  String
  amount       Decimal
  deadline     DateTime
  status       MilestoneStatus @default(ACTIVE)
  deliveryInfo Json[]          // [{content: string, links: string[], deadline: string}]
  metadata     Json?           @default("{}") // {rejectReason: string}
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  pod          Pod             @relation("PodMilestones", fields: [podId], references: [id], onDelete: Cascade)
  safeTransactionHash String?
  inactiveAt DateTime?
  
  @@index([podId])
  @@index([status])
}


enum ChainType {
  ETHEREUM
  OPTIMISM
}


enum PodStatus {
  REVIEWING // 审核中
  APPROVED // 批准
  REJECTED // 拒绝
  IN_PROGRESS // 进行中
  COMPLETED // 完成
  TERMINATED // 终止失败
}

enum MilestoneStatus {
  ACTIVE // 有效
  INACTIVE // 失效
  COMPLETED // 完成
  APPROVED // 批准
  REVIEWING // 审核中
  PENDING_DELIVERY // 待交付
  TERMINATED // 被终止 || 拒绝
}

model Notification {
  id         Int              @id @default(autoincrement())
  type       NotificationType @default(GENERAL)
  senderId   Int
  receiverId Int
  params     Json?
  title      String
  content    String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  metadata   Json?
  read       Boolean          @default(false)
  sender     User             @relation("SentNotifications", fields: [senderId], references: [id])
  receiver   User             @relation("ReceivedNotifications", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
}

enum NotificationType {
  GENERAL // 通用
  POD_REVIEW // 项目审核
  MILESTONE_REVIEW // 里程碑审核
  MILESTONE_DELIVERY_SUBMIT // 里程碑交付提交
  MILESTONE_CHANGE_REVIEW // 里程碑变更审核
}


// 交易记录表
/*
model Transaction {
  id Int @id @default(autoincrement())
  status TransactionStatus @default(PENDING)
  amount String
  createdAt DateTime @default(now())
  txHash String
  metadata Json? @default("{}")
  fromAddress String
  toAddress String
  currency String
  blockNumber Int
  blockTimestamp DateTime
}

enum TransactionStatus {
  PENDING // 待处理
  COMPLETED // 已完成
  ERROR // 异常
  OTHER // 其他
}
*/